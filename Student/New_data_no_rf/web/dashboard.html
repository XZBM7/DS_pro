<!doctype html>
<html lang="en" data-bs-theme="light">
<head>
<meta charset="utf-8">
<title>Dashboard | Student Performance Predictor</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
:root {
    --primary: #4361ee;
    --secondary: #3f37c9;
    --light: #f8f9fa;
    --dark: #212529;
    --success: #28a745;
    --info: #17a2b8;
    --warning: #ffc107;
    --danger: #dc3545;
    --gradient: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
}

[data-bs-theme="dark"] {
    --primary: #4cc9f0;
    --secondary: #4361ee;
    --light: #2d2d2d;
    --dark: #ffffff;
    --gradient: linear-gradient(135deg, #4cc9f0 0%, #4361ee 100%);
}

body {
    background: var(--light);
    min-height: 100vh;
    font-family: 'Inter', sans-serif;
    transition: background-color 0.3s ease;
}

.glass-card {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.5);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

[data-bs-theme="dark"] .glass-card {
    background: rgba(33, 37, 41, 0.85);
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
}

.nav-brand {
    font-weight: 700;
    font-size: 1.4rem;
    background: var(--gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.stats-card {
    padding: 1.5rem;
    text-align: center;
    height: 100%;
    border-radius: 16px;
    background: var(--bs-body-bg);
    border: 1px solid var(--bs-border-color);
    transition: transform 0.3s ease;
}

.stats-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
}

.icon-box {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1rem auto;
    font-size: 1.5rem;
}

.quick-action-card {
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    color: inherit;
    border: 1px solid transparent;
}

.quick-action-card:hover {
    background: rgba(67, 97, 238, 0.05);
    border-color: var(--primary);
    transform: scale(1.02);
}

.grade-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.bg-excellent { background-color: rgba(40, 167, 69, 0.15); color: var(--success); }
.bg-very-good { background-color: rgba(23, 162, 184, 0.15); color: var(--info); }
.bg-average { background-color: rgba(255, 193, 7, 0.15); color: #d39e00; }
.bg-risk { background-color: rgba(220, 53, 69, 0.15); color: var(--danger); }

.table-hover tbody tr:hover {
    background-color: rgba(67, 97, 238, 0.03);
}

.action-btn {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    transition: all 0.2s;
}

.action-btn:hover {
    background-color: rgba(220, 53, 69, 0.1);
    color: var(--danger);
}
</style>
</head>
<body>

<nav class="navbar navbar-expand-lg sticky-top mb-4 glass-card mx-3 mt-3">
    <div class="container-fluid px-4">
        <a class="navbar-brand nav-brand" href="/">
            <i class="bi bi-cpu me-2"></i>EduPredict AI
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item"><a class="nav-link active fw-semibold" href="/dashboard"><i class="bi bi-speedometer2 me-1"></i> Dashboard</a></li>
                <li class="nav-item"><a class="nav-link" href="/"><i class="bi bi-plus-circle me-1"></i> New Prediction</a></li>
                <li class="nav-item"><a class="nav-link" href="/analytics"><i class="bi bi-graph-up me-1"></i> Analytics</a></li>
                <li class="nav-item"><a class="nav-link" href="/insights"><i class="bi bi-lightbulb me-1"></i> Insights</a></li>
                <li class="nav-item"><a class="nav-link" href="/model_visuals"><i class="bi bi-diagram-3 me-1"></i> Model</a></li>
                <li class="nav-item"><a class="nav-link" href="/records"><i class="bi bi-table me-1"></i> Records</a></li>
            </ul>
            
            <div class="d-flex align-items-center gap-3">
                <button class="btn btn-link text-decoration-none p-0" onclick="toggleTheme()" id="themeBtn">
                    <i class="bi bi-sun-fill fs-5"></i>
                </button>
                
                <div class="dropdown">
                    <a href="#" class="d-flex align-items-center text-decoration-none dropdown-toggle" data-bs-toggle="dropdown">
                        <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 35px; height: 35px;">
                            <i class="bi bi-person-fill"></i>
                        </div>
                        <span class="fw-semibold d-none d-md-block" id="navUserName">User</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end glass-card border-0 shadow-sm mt-2">
                        <li><a class="dropdown-item" href="/profile"><i class="bi bi-person me-2"></i>Profile</a></li>
                        <li><a class="dropdown-item" href="/guide"><i class="bi bi-book me-2"></i>User Guide</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="logout()"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>

<div class="container-fluid px-4 pb-5">
    
    <div class="row mb-4">
        <div class="col-12">
            <div class="glass-card p-4 d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div>
                    <h2 class="fw-bold mb-1">Welcome back, <span id="welcomeName" class="text-primary">Student</span>! ðŸ‘‹</h2>
                    <p class="text-muted mb-0">Here's what's happening with your academic performance predictions.</p>
                </div>
                <a href="/" class="btn btn-primary px-4 py-2 rounded-pill shadow-sm">
                    <i class="bi bi-magic me-2"></i>Predict Now
                </a>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-md-6 col-xl-3">
            <div class="stats-card">
                <div class="icon-box bg-primary bg-opacity-10 text-primary">
                    <i class="bi bi-files"></i>
                </div>
                <h3 class="fw-bold mb-1" id="statTotal">0</h3>
                <span class="text-muted small">Total Predictions</span>
            </div>
        </div>
        <div class="col-md-6 col-xl-3">
            <div class="stats-card">
                <div class="icon-box bg-info bg-opacity-10 text-info">
                    <i class="bi bi-percent"></i>
                </div>
                <h3 class="fw-bold mb-1" id="statAverage">0.0</h3>
                <span class="text-muted small">Average Score</span>
            </div>
        </div>
        <div class="col-md-6 col-xl-3">
            <div class="stats-card">
                <div class="icon-box bg-success bg-opacity-10 text-success">
                    <i class="bi bi-trophy"></i>
                </div>
                <h3 class="fw-bold mb-1" id="statExcellent">0</h3>
                <span class="text-muted small">Excellent Results</span>
            </div>
        </div>
        <div class="col-md-6 col-xl-3">
            <div class="stats-card">
                <div class="icon-box bg-danger bg-opacity-10 text-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                </div>
                <h3 class="fw-bold mb-1" id="statRisk">0</h3>
                <span class="text-muted small">At Risk Warnings</span>
            </div>
        </div>
    </div>

    <div class="row g-4">
        
        <div class="col-lg-4">
            <div class="glass-card p-4 mb-4 h-100">
                <h5 class="fw-bold mb-4"><i class="bi bi-lightning-charge me-2"></i>Quick Actions</h5>
                <div class="d-grid gap-3">
                    <a href="/" class="quick-action-card p-3 rounded d-flex align-items-center bg-light">
                        <div class="bg-white p-2 rounded shadow-sm text-primary me-3">
                            <i class="bi bi-calculator"></i>
                        </div>
                        <div>
                            <h6 class="mb-0 fw-semibold">New Prediction</h6>
                            <small class="text-muted">Input new data</small>
                        </div>
                        <i class="bi bi-chevron-right ms-auto text-muted"></i>
                    </a>
                    
                    <a href="/insights" class="quick-action-card p-3 rounded d-flex align-items-center bg-light">
                        <div class="bg-white p-2 rounded shadow-sm text-info me-3">
                            <i class="bi bi-robot"></i>
                        </div>
                        <div>
                            <h6 class="mb-0 fw-semibold">AI Insights</h6>
                            <small class="text-muted">Get recommendations</small>
                        </div>
                        <i class="bi bi-chevron-right ms-auto text-muted"></i>
                    </a>
                    
                    <a href="/analytics" class="quick-action-card p-3 rounded d-flex align-items-center bg-light">
                        <div class="bg-white p-2 rounded shadow-sm text-success me-3">
                            <i class="bi bi-bar-chart-line"></i>
                        </div>
                        <div>
                            <h6 class="mb-0 fw-semibold">Detailed Analytics</h6>
                            <small class="text-muted">Visualize trends</small>
                        </div>
                        <i class="bi bi-chevron-right ms-auto text-muted"></i>
                    </a>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="glass-card p-4 h-100">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="fw-bold mb-0"><i class="bi bi-clock-history me-2"></i>Recent Predictions</h5>
                    <div>
                        <button onclick="loadData()" class="btn btn-sm btn-outline-secondary me-2" title="Refresh">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                        <a href="/records" class="btn btn-sm btn-outline-primary">View All</a>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Date</th>
                                <th>Predicted Score</th>
                                <th>Level</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recentTableBody">
                            <tr>
                                <td colspan="4" class="text-center py-4 text-muted">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                    Loading predictions...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glass-card border-0">
            <div class="modal-body text-center p-4">
                <div class="text-danger mb-3">
                    <i class="bi bi-trash3 fs-1"></i>
                </div>
                <h5 class="fw-bold">Delete Prediction?</h5>
                <p class="text-muted">This action cannot be undone. Are you sure you want to remove this record?</p>
                <div class="d-flex justify-content-center gap-2 mt-4">
                    <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger px-4" id="confirmDeleteBtn">Delete</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function toggleTheme() {
        const html = document.documentElement;
        const current = html.getAttribute('data-bs-theme');
        const next = current === 'dark' ? 'light' : 'dark';
        html.setAttribute('data-bs-theme', next);
        localStorage.setItem('theme', next);
        updateThemeIcon(next);
    }

    function updateThemeIcon(theme) {
        const btn = document.getElementById('themeBtn');
        if(theme === 'dark') {
            btn.innerHTML = '<i class="bi bi-moon-fill fs-5"></i>';
        } else {
            btn.innerHTML = '<i class="bi bi-sun-fill fs-5"></i>';
        }
    }

    async function logout() {
        try {
            await fetch('/api/logout', { method: 'POST' });
            window.location.href = '/login';
        } catch (e) {
            console.error(e);
        }
    }

    let deleteId = null;

    async function loadData() {
        try {
            const userRes = await fetch('/api/user');
            if (userRes.status === 401) return window.location.href = '/login';
            const userData = await userRes.json();
            
            if (userData.ok) {
                const name = userData.user.full_name || userData.user.username;
                document.getElementById('navUserName').innerText = name;
                document.getElementById('welcomeName').innerText = name.split(' ')[0];
            }

            const statsRes = await fetch('/api/user/stats');
            const statsJson = await statsRes.json();
            
            if (statsJson.ok) {
                const s = statsJson.stats;
                animateValue('statTotal', s.total_predictions);
                animateValue('statAverage', s.average_grade, true);
                animateValue('statExcellent', s.excellent_count);
                animateValue('statRisk', s.risk_count);
            }

            const recRes = await fetch('/api/records');
            const recJson = await recRes.json();
            
            if (recJson.ok) {
                renderTable(recJson.rows);
            }

        } catch (error) {
            console.error("Dashboard load error:", error);
        }
    }

    function renderTable(rows) {
        const tbody = document.getElementById('recentTableBody');
        if (!rows || rows.length === 0) {
            tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-muted">No predictions found. Start by creating one!</td></tr>`;
            return;
        }

        const recent = rows.slice(0, 5); 

        tbody.innerHTML = recent.map(row => {
            const date = new Date(row.created_at).toLocaleDateString(undefined, {
                month: 'short', day: 'numeric', year: 'numeric'
            });
            const score = parseFloat(row.pred).toFixed(1);
            
            return `
                <tr>
                    <td class="text-muted fw-medium">${date}</td>
                    <td>
                        <div class="fw-bold">${score} <span class="text-muted small">/ 100</span></div>
                    </td>
                    <td>${getLevelBadge(row.level)}</td>
                    <td class="text-end">
                        <button class="btn btn-link text-danger p-0 action-btn ms-auto" onclick="promptDelete('${row._id}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function getLevelBadge(level) {
        let cls = 'bg-secondary';
        let icon = 'bi-question-circle';
        
        if (level === 'Excellent') { cls = 'bg-excellent'; icon = 'bi-star-fill'; }
        else if (level === 'Very Good') { cls = 'bg-very-good'; icon = 'bi-hand-thumbs-up-fill'; }
        else if (level === 'Needs Improvement') { cls = 'bg-average'; icon = 'bi-exclamation-circle-fill'; }
        else if (level === 'At Risk') { cls = 'bg-risk'; icon = 'bi-shield-exclamation'; }

        return `<span class="grade-badge ${cls}"><i class="bi ${icon}"></i> ${level}</span>`;
    }

    function animateValue(id, value, isFloat=false) {
        const obj = document.getElementById(id);
        const start = 0;
        const end = parseFloat(value);
        if (isNaN(end)) return;
        
        let current = 0;
        const duration = 1000;
        const stepTime = 20;
        const steps = duration / stepTime;
        const increment = end / steps;
        
        const timer = setInterval(() => {
            current += increment;
            if (current >= end) {
                current = end;
                clearInterval(timer);
            }
            obj.innerHTML = isFloat ? current.toFixed(1) : Math.round(current);
        }, stepTime);
    }

    function promptDelete(id) {
        deleteId = id;
        new bootstrap.Modal(document.getElementById('deleteModal')).show();
    }

    document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
        if (!deleteId) return;
        try {
            const res = await fetch(`/api/delete/${deleteId}`, { method: 'DELETE' });
            const data = await res.json();
            if (data.ok) {
                loadData();
                bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
            } else {
                alert('Failed to delete: ' + (data.error || 'Unknown error'));
            }
        } catch (e) {
            console.error(e);
            alert('Server error while deleting');
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-bs-theme', savedTheme);
        updateThemeIcon(savedTheme);
        loadData();
    });
</script>
</body>
</html>