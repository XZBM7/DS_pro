<!doctype html>
<html lang="en" data-bs-theme="light">
<head>
<meta charset="utf-8">
<title>Advanced Analytics | Student Predictor</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
    --primary: #4361ee;
    --secondary: #3f37c9;
    --success: #4cc9f0;
    --info: #4895ef;
    --warning: #f72585;
    --light: #f8f9fa;
    --dark: #212529;
    --gradient: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
    --card-bg: rgba(255, 255, 255, 0.95);
    --text-primary: #212529;
    --text-secondary: #6c757d;
    --border-color: rgba(0, 0, 0, 0.1);
}

[data-bs-theme="dark"] {
    --card-bg: rgba(33, 37, 41, 0.95);
    --text-primary: #f8f9fa;
    --text-secondary: #adb5bd;
    --border-color: rgba(255, 255, 255, 0.1);
    --light: #343a40;
}

body {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    min-height: 100vh;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: var(--text-primary);
    transition: all 0.5s ease;
}

[data-bs-theme="dark"] body {
    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
}

.glass-card {
    background: var(--card-bg);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    border: 1px solid var(--border-color);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    transition: all 0.5s ease;
}

.gradient-bg {
    background: var(--gradient);
}

.nav-brand {
    font-weight: 700;
    font-size: 1.5rem;
    background: var(--gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.feature-icon {
    width: 60px;
    height: 60px;
    border-radius: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    margin-bottom: 1rem;
}

.stats-card {
    background: var(--card-bg);
    border-radius: 15px;
    padding: 1.5rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    transition: all 0.5s ease;
    border: 1px solid var(--border-color);
}

.stats-card:hover {
    transform: translateY(-5px);
}

.progress-custom {
    height: 8px;
    border-radius: 10px;
    background: var(--light);
}

.progress-custom .progress-bar {
    border-radius: 10px;
    transition: width 1s ease-in-out;
}

.animated-card {
    animation: fadeInUp 0.6s ease-out;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.theme-toggle {
    cursor: pointer;
    transition: all 0.3s ease;
}

.theme-toggle:hover {
    transform: scale(1.1);
}

.chart-container {
    position: relative;
    height: 300px;
    width: 100%;
}

.performance-badge {
    padding: 8px 16px;
    border-radius: 25px;
    font-weight: 600;
    font-size: 0.9rem;
    transition: all 0.3s ease;
}

.insight-card {
    background: var(--card-bg);
    border-left: 4px solid var(--primary);
    padding: 1rem;
    margin-bottom: 1rem;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.insight-card:hover {
    transform: translateX(5px);
}

.fade-in {
    animation: fadeIn 0.8s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.slide-in-left {
    animation: slideInLeft 0.8s ease-out;
}

@keyframes slideInLeft {
    from {
        opacity: 0;
        transform: translateX(-50px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.pulse {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}
</style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light glass-card mb-4">
    <div class="container">
        <a class="navbar-brand nav-brand" href="/">
            <i class="bi bi-graph-up-arrow me-2"></i>
            EduPredict AI
        </a>
        <div class="navbar-nav ms-auto">
            <a class="nav-link" href="/">
                <i class="bi bi-house me-1"></i>Home
            </a>
            <a class="nav-link" href="/dashboard">
                <i class="bi bi-speedometer2 me-1"></i>Dashboard
            </a>
            <a class="nav-link active" href="/statistics">
                <i class="bi bi-bar-chart me-1"></i>Analytics
            </a>
            <a class="nav-link theme-toggle" onclick="toggleTheme()">
                <i class="bi bi-moon-stars" id="themeIcon"></i>
            </a>
        </div>
    </div>
</nav>

<div class="container">
    <div class="row mb-5">
        <div class="col-12 text-center">
            <h1 class="display-4 fw-bold mb-3">Advanced Analytics</h1>
            <p class="lead text-muted">Comprehensive insights and performance metrics</p>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="stats-card text-center animated-card">
                <div class="feature-icon gradient-bg text-white mx-auto">
                    <i class="bi bi-people"></i>
                </div>
                <h3 class="fw-bold" id="totalStudents">0</h3>
                <p class="text-muted mb-0">Total Predictions</p>
                <div class="progress progress-custom mt-2">
                    <div class="progress-bar bg-primary" style="width: 100%"></div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card text-center animated-card slide-in-left">
                <div class="feature-icon bg-success bg-opacity-10 text-success rounded-circle mx-auto">
                    <i class="bi bi-graph-up"></i>
                </div>
                <h3 class="fw-bold" id="avgGrade">0.0</h3>
                <p class="text-muted mb-0">Average Grade</p>
                <div class="progress progress-custom mt-2">
                    <div class="progress-bar bg-success" style="width: 75%"></div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card text-center animated-card slide-in-left">
                <div class="feature-icon bg-info bg-opacity-10 text-info rounded-circle mx-auto">
                    <i class="bi bi-star"></i>
                </div>
                <h3 class="fw-bold" id="excellentCount">0</h3>
                <p class="text-muted mb-0">Excellent Students</p>
                <div class="progress progress-custom mt-2">
                    <div class="progress-bar bg-info" style="width: 25%"></div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card text-center animated-card slide-in-left">
                <div class="feature-icon bg-warning bg-opacity-10 text-warning rounded-circle mx-auto">
                    <i class="bi bi-exclamation-triangle"></i>
                </div>
                <h3 class="fw-bold" id="riskCount">0</h3>
                <p class="text-muted mb-0">At Risk Students</p>
                <div class="progress progress-custom mt-2">
                    <div class="progress-bar bg-warning" style="width: 15%"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-6">
            <div class="glass-card p-4 animated-card">
                <h5 class="mb-4"><i class="bi bi-pie-chart me-2"></i>Grade Distribution</h5>
                <div class="chart-container">
                    <canvas id="gradeDistributionChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="glass-card p-4 animated-card">
                <h5 class="mb-4"><i class="bi bi-graph-up-arrow me-2"></i>Performance Trends</h5>
                <div class="chart-container">
                    <canvas id="performanceTrendChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="glass-card p-4 animated-card">
                <h5 class="mb-4"><i class="bi bi-clock me-2"></i>Study Time Impact</h5>
                <div class="chart-container">
                    <canvas id="studyTimeChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="glass-card p-4 animated-card">
                <h5 class="mb-4"><i class="bi bi-activity me-2"></i>Factor Correlation</h5>
                <div class="chart-container">
                    <canvas id="correlationChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div class="glass-card p-4 animated-card">
                <h5 class="mb-4"><i class="bi bi-lightbulb me-2"></i>AI Insights & Recommendations</h5>
                <div class="row" id="insightsContainer">
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function toggleTheme() {
    const html = document.documentElement;
    const themeIcon = document.getElementById('themeIcon');
    const currentTheme = html.getAttribute('data-bs-theme');
    
    if (currentTheme === 'dark') {
        html.setAttribute('data-bs-theme', 'light');
        themeIcon.className = 'bi bi-moon-stars';
    } else {
        html.setAttribute('data-bs-theme', 'dark');
        themeIcon.className = 'bi bi-sun';
    }
    
    localStorage.setItem('theme', html.getAttribute('data-bs-theme'));
}

function initTheme() {
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-bs-theme', savedTheme);
    const themeIcon = document.getElementById('themeIcon');
    themeIcon.className = savedTheme === 'dark' ? 'bi bi-sun' : 'bi bi-moon-stars';
}

let charts = {};

function initCharts() {
    const gradeCtx = document.getElementById('gradeDistributionChart').getContext('2d');
    charts.gradeDistribution = new Chart(gradeCtx, {
        type: 'doughnut',
        data: {
            labels: ['At Risk (<10)', 'Needs Improvement (10-13)', 'Very Good (14-17)', 'Excellent (18-20)'],
            datasets: [{
                data: [0, 0, 0, 0],
                backgroundColor: ['#dc3545', '#ffc107', '#17a2b8', '#28a745'],
                borderWidth: 2,
                borderColor: 'var(--card-bg)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: 'var(--text-primary)',
                        padding: 20
                    }
                }
            },
            animation: {
                animateScale: true,
                animateRotate: true
            }
        }
    });

    const trendCtx = document.getElementById('performanceTrendChart').getContext('2d');
    charts.performanceTrend = new Chart(trendCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Average Grade',
                data: [],
                borderColor: '#4361ee',
                backgroundColor: 'rgba(67, 97, 238, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: false,
                    min: 0,
                    max: 20,
                    grid: {
                        color: 'var(--border-color)'
                    },
                    ticks: {
                        color: 'var(--text-secondary)'
                    }
                },
                x: {
                    grid: {
                        color: 'var(--border-color)'
                    },
                    ticks: {
                        color: 'var(--text-secondary)'
                    }
                }
            },
            plugins: {
                legend: {
                    labels: {
                        color: 'var(--text-primary)'
                    }
                }
            }
        }
    });

    const studyCtx = document.getElementById('studyTimeChart').getContext('2d');
    charts.studyTime = new Chart(studyCtx, {
        type: 'bar',
        data: {
            labels: ['Very Low', 'Low', 'Medium', 'High'],
            datasets: [{
                label: 'Average Grade',
                data: [0, 0, 0, 0],
                backgroundColor: [
                    'rgba(220, 53, 69, 0.8)',
                    'rgba(255, 193, 7, 0.8)',
                    'rgba(23, 162, 184, 0.8)',
                    'rgba(40, 167, 69, 0.8)'
                ],
                borderColor: [
                    '#dc3545',
                    '#ffc107',
                    '#17a2b8',
                    '#28a745'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 20,
                    grid: {
                        color: 'var(--border-color)'
                    },
                    ticks: {
                        color: 'var(--text-secondary)'
                    }
                },
                x: {
                    grid: {
                        color: 'var(--border-color)'
                    },
                    ticks: {
                        color: 'var(--text-secondary)'
                    }
                }
            },
            plugins: {
                legend: {
                    labels: {
                        color: 'var(--text-primary)'
                    }
                }
            }
        }
    });

    const correlationCtx = document.getElementById('correlationChart').getContext('2d');
    charts.correlation = new Chart(correlationCtx, {
        type: 'radar',
        data: {
            labels: ['Exam Scores', 'Study Time', 'Attendance', 'Past Performance', 'Resources'],
            datasets: [{
                label: 'Impact on Final Grade',
                data: [0, 0, 0, 0, 0],
                backgroundColor: 'rgba(67, 97, 238, 0.2)',
                borderColor: '#4361ee',
                pointBackgroundColor: '#4361ee',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: '#4361ee'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: {
                    angleLines: {
                        color: 'var(--border-color)'
                    },
                    grid: {
                        color: 'var(--border-color)'
                    },
                    pointLabels: {
                        color: 'var(--text-primary)'
                    },
                    ticks: {
                        color: 'var(--text-secondary)',
                        backdropColor: 'transparent'
                    }
                }
            },
            plugins: {
                legend: {
                    labels: {
                        color: 'var(--text-primary)'
                    }
                }
            }
        }
    });
}

function updateCharts(data) {
    const rows = data.rows;
    
    if (rows.length === 0) return;

    document.getElementById('totalStudents').textContent = rows.length;
    
    const avgGrade = rows.reduce((sum, r) => sum + r.pred, 0) / rows.length;
    document.getElementById('avgGrade').textContent = avgGrade.toFixed(1);
    
    const excellentCount = rows.filter(r => r.level === 'Excellent').length;
    const riskCount = rows.filter(r => r.level === 'At Risk').length;
    document.getElementById('excellentCount').textContent = excellentCount;
    document.getElementById('riskCount').textContent = riskCount;

    const gradeRanges = {
        risk: rows.filter(r => r.pred < 10).length,
        needsImprovement: rows.filter(r => r.pred >= 10 && r.pred < 14).length,
        veryGood: rows.filter(r => r.pred >= 14 && r.pred < 18).length,
        excellent: rows.filter(r => r.pred >= 18).length
    };
    
    charts.gradeDistribution.data.datasets[0].data = [
        gradeRanges.risk,
        gradeRanges.needsImprovement,
        gradeRanges.veryGood,
        gradeRanges.excellent
    ];
    charts.gradeDistribution.update();

    const recentRows = rows.slice(-7);
    charts.performanceTrend.data.labels = recentRows.map((r, i) => `Pred ${i + 1}`);
    charts.performanceTrend.data.datasets[0].data = recentRows.map(r => r.pred);
    charts.performanceTrend.update();

    const studyTimeData = [1, 2, 3, 4].map(level => {
        const levelRows = rows.filter(r => r.study_time === level);
        return levelRows.length > 0 ? 
            levelRows.reduce((sum, r) => sum + r.pred, 0) / levelRows.length : 0;
    });
    charts.studyTime.data.datasets[0].data = studyTimeData;
    charts.studyTime.update();

    const examImpact = Math.min(10, (rows.reduce((sum, r) => sum + (r.first_exam_grade + r.second_exam_grade) / 2, 0) / rows.length) / 2);
    const studyImpact = Math.min(10, rows.reduce((sum, r) => sum + (r.study_time * 2), 0) / rows.length);
    const attendanceImpact = Math.min(10, (20 - (rows.reduce((sum, r) => sum + Math.min(r.absences / 10, 10), 0) / rows.length)));
    const pastImpact = Math.min(10, 10 - (rows.reduce((sum, r) => sum + r.past_failures, 0) / rows.length));
    const resourcesImpact = Math.min(10, (rows.filter(r => r.internet === 'yes').length / rows.length) * 10);
    
    charts.correlation.data.datasets[0].data = [
        examImpact,
        studyImpact,
        attendanceImpact,
        pastImpact,
        resourcesImpact
    ];
    charts.correlation.update();

    generateInsights(rows, avgGrade, excellentCount, riskCount);
}

function generateInsights(rows, avgGrade, excellentCount, riskCount) {
    const insightsContainer = document.getElementById('insightsContainer');
    const total = rows.length;
    
    const insights = [];
    
    if (excellentCount / total > 0.3) {
        insights.push({
            icon: 'bi-star-fill',
            color: 'success',
            title: 'High Achievers',
            content: `${excellentCount} students (${((excellentCount/total)*100).toFixed(1)}%) are performing excellently. Consider advanced challenges for these students.`
        });
    }
    
    if (riskCount / total > 0.2) {
        insights.push({
            icon: 'bi-exclamation-triangle',
            color: 'danger',
            title: 'Intervention Needed',
            content: `${riskCount} students (${((riskCount/total)*100).toFixed(1)}%) are at risk. Immediate academic support recommended.`
        });
    }
    
    if (avgGrade > 14) {
        insights.push({
            icon: 'bi-graph-up',
            color: 'info',
            title: 'Strong Performance',
            content: `Class average of ${avgGrade.toFixed(1)} indicates overall good academic environment.`
        });
    } else if (avgGrade < 10) {
        insights.push({
            icon: 'bi-graph-down',
            color: 'warning',
            title: 'Improvement Opportunity',
            content: `Class average of ${avgGrade.toFixed(1)} suggests need for curriculum review and additional support.`
        });
    }

    const lowStudyTime = rows.filter(r => r.study_time <= 2).length;
    if (lowStudyTime / total > 0.4) {
        insights.push({
            icon: 'bi-clock',
            color: 'warning',
            title: 'Study Habits',
            content: `${((lowStudyTime/total)*100).toFixed(1)}% of students have low study time. Consider study skills workshops.`
        });
    }

    const highAbsences = rows.filter(r => r.absences > 10).length;
    if (highAbsences > 0) {
        insights.push({
            icon: 'bi-calendar-x',
            color: 'danger',
            title: 'Attendance Alert',
            content: `${highAbsences} students have high absence rates affecting their performance.`
        });
    }

    insightsContainer.innerHTML = insights.map(insight => `
        <div class="col-md-6 mb-3">
            <div class="insight-card fade-in">
                <div class="d-flex align-items-center mb-2">
                    <i class="bi ${insight.icon} text-${insight.color} me-2"></i>
                    <h6 class="mb-0 text-${insight.color}">${insight.title}</h6>
                </div>
                <p class="mb-0 small">${insight.content}</p>
            </div>
        </div>
    `).join('');
}

async function loadStatistics() {
    try {
        const response = await fetch('/records');
        const data = await response.json();
        
        if (data.ok) {
            updateCharts(data);
        } else {
            console.error('Error loading statistics:', data.error);
        }
    } catch (error) {
        console.error('Error loading statistics:', error);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    initTheme();
    initCharts();
    loadStatistics();
    
    setInterval(loadStatistics, 30000);
});
</script>
</body>
</html>